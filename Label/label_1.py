#coding:utf-8
#运行此代码钱请将所有的家族名称统一为"AgentTesla","AveMaria","Formbook","Ursnif","GuLoader","Emotet","IcedID","Lokibot","MassLogger RAT","NanoCore","njRat","Remcos","Trickbot","ZeuS"
from selenium import webdriver
import time
from PIL import Image
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
import pandas as pd
import xlrd
import os
import shutil
import sys
#读取样本初始标签
def read_first_label(path_1):#path_1是初始样本标签csv的路径
    #打开excel
    wb = xlrd.open_workbook(path_1)
    #按工作簿定位工作表
    sh = wb.sheet_by_name('sheet1')
    all_yangben=[]
    for i in range(sh.nrows):
        if i==0:
            continue
        lst=[]
        lst.append(sh.row_values(i)[0])
        lst.append(sh.row_values(i)[1])
        all_yangben.append(lst)
    return all_yangben
#从网站爬取样本标签并且筛选出依据1,2,3一致的样本作为迁移学习训练数据
def search_label(path_2):#path_2是恶意软件所有RGB图的路径
    all_yangben=read_first_label(sys.argv[1])
    first_shaixuan=[]
    chrome_options = Options()
    chrome_options.add_argument('--headless')
    options = webdriver.ChromeOptions()
    options.add_argument('user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"')
    driver = webdriver.Chrome(chrome_options=chrome_options)
    url = "https://www.joesandbox.com/analysispaged/0"
    driver.get(url)
    search_table=driver.find_element_by_css_selector("#cloudbasic > div.navbar.navbar-fixed-top.navbar-big > div.navbar-inner > div > div > div.btn-group.pull-left > form > input")
    for i in range(len(all_yangben)):
        search_table.clear()
        search_table.send_keys(all_yangben[i][0])
        search_table.send_keys(Keys.ENTER)
        time.sleep(4)
        if driver.find_element_by_css_selector("#all_analyses_list > tbody > tr > td:nth-child(3) > div"):
            label=driver.find_element_by_css_selector("#all_analyses_list > tbody > tr > td:nth-child(3) > div").text
            all_yangben[i].append(label)
        else:
            all_yangben[i].append("")
        if all_yangben[i][1]==all_yangben[i][2]:
            first_shaixuan.append(all_yangben[i])
    name=["sh256","label1","label2"]
    all=pd.DataFrame(columns=name,data=all_yangben)
    all.to_csv('all_label.csv',encoding='utf-8')
    first=pd.DataFrame(columns=name,data=first_shaixuan)
    first.to_csv('first_shaixuan_111.csv',encoding='utf-8')
    familys=["AgentTesla","AveMaria","Formbook","Ursnif","GuLoader","Emotet","IcedID","Lokibot","MassLogger RAT","NanoCore","njRat","Remcos","Trickbot","ZeuS"]
    os.mkdir(path_2+"111")#代表依据1,2,3一致
    os.mkdir(path_2+"000")#代表依据1,2,3不完全一致
    all_png=os.listdir(path_2)
    for png in all_png:
        str1,sep,tail=png.partition('.')
        lab=""
        for i in range(len(first_shaixuan)):
            if first_shaixuan[i][0]==str1:
                lab=first_shaixuan[1]
                break
        if lab=="":
            shutil.copy(path_2+png,path_2+"/000")
        else:
            if not os.path.isdir(path_2+"/111/"+lab):
                os.mkdir(path_2+"/111/"+lab)
            shutil.copy(path_2+png,path_2+"/111/"+lab)
    # cnn(path_2+"/111")
    # vgg16(path_2+"/111")

search_label(sys.argv[2]) 
path=sys.argv[2]+"/111"
#运行完此代码接下来运行cnn和vgg16模型的训练代码
os.system('chmod +x model.sh')
os.system('sh model.sh '+path)